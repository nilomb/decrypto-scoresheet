<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable-status-bar-style" content="black-translucent">
  <title>Decrypto Style Pages</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      height: 100dvh;
      overflow-x: hidden;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .page-wrapper {
      flex: 1;
      position: relative;
    }

    .page-container {
      display: flex;
      width: 800%;
      height: 100%;
      transition: margin-left 0.3s ease;
    }

    .page {
      width: 12.5%;
      height: 100%;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    /* Top box */
    .top-box {
      width: 100%;
      background: #f0f0f0;
      padding: 10px;
      box-sizing: border-box;
    }
    body.them .top-box {
      background: #ddd;
      color: #000;
    }

    .nav-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      align-items: center;
    }

    .page-nav {
      display: flex;
      gap: 6px;
    }
    .page-nav button {
      background: #ccc;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s, color 0.3s;
    }
    .page-nav button.active {
      background: #333;
      color: #fff;
      font-weight: bold;
    }

    .mode-nav {
      display: flex;
      gap: 6px;
    }
    .mode-nav button {
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      background: #ccc;
      transition: background 0.3s, color 0.3s;
    }
    .mode-nav button.active {
      background: #333;
      color: #fff;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .row input[type="text"] {
      flex: 1;
      margin-right: 8px;
      padding: 6px;
    }
    .row input[type="number"] {
      width: 50px;
      padding: 6px;
      margin-left: 4px;
    }

    /* Prevent iOS zoom on top-box inputs */
    .top-box input[type="text"],
    .top-box input[type="number"] {
      font-size: 16px;
    }

    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 8px;
      padding: 8px;
      box-sizing: border-box;
    }

    .panel {
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }

    .panel-top {
      flex: 1;
      padding: 6px;
      overflow-y: auto;
    }
    .panel-top ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .panel-top li {
      padding: 2px 0;
      border-bottom: 1px solid #eee;
      font-size: 16px;
    }

    .panel-bottom {
      border-top: 1px solid #ddd;
      padding: 4px;
      background: #fafafa;
      max-height: 80px;
      overflow-y: auto;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .note-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .note-item span {
      flex: 1;
      font-size: 16px;
    }
    .note-item span.strikethrough {
      text-decoration: line-through;
    }
    .note-item button {
      margin-left: 4px;
      padding: 2px 6px;
      cursor: pointer;
    }

    .note-input {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }
    .note-input input {
      flex: 1;
      padding: 4px;
      font-size: 16px;
    }

    .new-game-btn {
      background: #ccc;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .new-game-btn:hover {
      background: #999;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="page-container" id="usPages"></div>
    <div class="page-container" id="themPages" style="display:none;"></div>
  </div>

  <script>
    const collectedWords = { us: [[], [], [], []], them: [[], [], [], []] };
    const manualNotes = { us: [[], [], [], []], them: [[], [], [], []] };

    let wordlist = [];
    let usRandomWords = [];

    async function loadWordlist() {
      try {
        const response = await fetch("wordlist.txt");
        const text = await response.text();
        wordlist = text.split(/\r?\n/).map(w => w.trim().toUpperCase()).filter(Boolean);
        newGame();
      } catch (e) {
        console.error("Could not load wordlist.txt", e);
      }
    }

    function newGame() {
      if (wordlist.length < 4) return;
      const shuffled = [...wordlist].sort(() => 0.5 - Math.random());
      usRandomWords = shuffled.slice(0, 4);
      updateUSWords();
    }

    function updateUSWords() {
      document.querySelectorAll("#usPages .page").forEach(page => {
        page.querySelectorAll(".panel-bottom").forEach((panelBottom, i) => {
          panelBottom.textContent = usRandomWords[i] || "";
        });
      });
    }

    function createTopBox(pageIndex, containerId) {
      const topBox = document.createElement('div');
      topBox.className = 'top-box';

      const navRow = document.createElement('div');
      navRow.className = 'nav-row';

      const pageNav = document.createElement('div');
      pageNav.className = 'page-nav';
      for (let i = 0; i < 8; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        if (i === 0 && pageIndex === 1 && containerId === "usPages") btn.classList.add('active');
        btn.addEventListener('click', () => {
          currentPage = i;
          updatePagePosition();
          updateAllNavs();
          updateAllPanels();
          updateAllNotes();
        });
        pageNav.appendChild(btn);
      }

      if (containerId === "usPages" && pageIndex === 1) {
        const newGameBtn = document.createElement("button");
        newGameBtn.className = "new-game-btn";
        newGameBtn.textContent = "↻";
        newGameBtn.addEventListener("click", newGame);
        pageNav.appendChild(newGameBtn);
      }

      const modeNav = document.createElement('div');
      modeNav.className = 'mode-nav';
      const usBtn = document.createElement('button');
      usBtn.textContent = "US";
      if (containerId === "usPages") usBtn.classList.add('active');
      usBtn.addEventListener('click', () => switchMode('us'));
      const themBtn = document.createElement('button');
      themBtn.textContent = "THEM";
      if (containerId === "themPages") themBtn.classList.add('active');
      themBtn.addEventListener('click', () => switchMode('them'));
      modeNav.appendChild(usBtn);
      modeNav.appendChild(themBtn);

      navRow.appendChild(pageNav);
      navRow.appendChild(modeNav);
      topBox.appendChild(navRow);

      for (let i = 0; i < 3; i++) {
        const row = document.createElement('div');
        row.className = 'row';

        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.placeholder = 'Word';
        textInput.enterKeyHint = "done";
        row.appendChild(textInput);

        let confirmed = false;
        textInput.addEventListener('keydown', (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            confirmed = true;
            textInput.blur();
          }
        });
        textInput.addEventListener('blur', () => {
          if (!confirmed) {
            textInput.value = "";
          }
          confirmed = false;
        });

        const numberInput1 = document.createElement('input');
        numberInput1.type = 'number';
        numberInput1.min = 1;
        numberInput1.max = 4;
        numberInput1.inputMode = "numeric";
        numberInput1.enterKeyHint = "done";
        numberInput1.style.fontSize = "16px";
        row.appendChild(numberInput1);

        const numberInput2 = document.createElement('input');
        numberInput2.type = 'number';
        numberInput2.min = 1;
        numberInput2.max = 4;
        numberInput2.inputMode = "numeric";
        numberInput2.enterKeyHint = "done";
        numberInput2.style.fontSize = "16px";
        row.appendChild(numberInput2);

        [numberInput1, numberInput2].forEach(numInput => {
          let confirmed = false;
          numInput.addEventListener("keydown", e => {
            if (e.key === "Enter") {
              e.preventDefault();
              const value = parseInt(numInput.value, 10);
              if (value >= 1 && value <= 4) {
                confirmed = true;
                numInput.blur();
              } else {
                numInput.value = "";
              }
            }
          });
          numInput.addEventListener("blur", () => {
            if (!confirmed) {
              numInput.value = "";
            }
            confirmed = false;
          });
        });

        numberInput2.addEventListener('change', () => {
          const word = textInput.value.trim();
          const panelIndex = parseInt(numberInput2.value) - 1;
          if (word && panelIndex >= 0 && panelIndex < 4) {
            addOrMoveWord(word, panelIndex);
          }
        });

        topBox.appendChild(row);
      }
      return topBox;
    }

    function createGrid(pageIndex) {
      const grid = document.createElement('div');
      grid.className = 'grid';
      for (let i = 0; i < 4; i++) {
        const panel = document.createElement('div');
        panel.className = 'panel';

        const panelTop = document.createElement('div');
        panelTop.className = 'panel-top';
        const ul = document.createElement('ul');
        panelTop.appendChild(ul);

        const panelBottom = document.createElement('div');
        panelBottom.className = 'panel-bottom';
        panelBottom.dataset.panelIndex = i;
        grid.appendChild(panel);

        panel.appendChild(panelTop);
        panel.appendChild(panelBottom);
      }
      return grid;
    }

    function buildPages(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      for (let p = 1; p <= 8; p++) {
        const page = document.createElement('div');
        page.className = 'page';
        page.appendChild(createTopBox(p, containerId));
        page.appendChild(createGrid(p - 1));
        container.appendChild(page);
      }
    }

    let currentPage = 0;
    let currentMode = 'us';
    const lastPageByMode = { us: 0, them: 0 };

    function updatePagePosition() {
      const container = document.getElementById(currentMode + 'Pages');
      container.style.marginLeft = `-${currentPage * 100}%`;
    }

    function updateAllNavs() {
      document.querySelectorAll('.page-nav').forEach(nav => {
        nav.querySelectorAll('button').forEach((btn, i) => {
          btn.classList.toggle('active', i === currentPage);
        });
      });
    }

    function addOrMoveWord(word, newPanelIndex) {
      for (let i = 0; i < 4; i++) {
        collectedWords[currentMode][i] = collectedWords[currentMode][i].filter(
          item => !(item.word === word && item.fromPage === currentPage)
        );
      }
      collectedWords[currentMode][newPanelIndex].push({ word, fromPage: currentPage });
      updateAllPanels();
    }

    function updateAllPanels() {
      document.querySelectorAll(`#${currentMode}Pages .page`).forEach((page, pageIndex) => {
        const grids = page.querySelectorAll('.grid');
        grids.forEach(grid => {
          grid.querySelectorAll('.panel').forEach((panel, i) => {
            const ul = panel.querySelector('.panel-top ul');
            ul.innerHTML = '';
            collectedWords[currentMode][i]
              .filter(item => item.fromPage <= pageIndex)
              .forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.word;
                ul.appendChild(li);
              });
          });
        });
      });
    }

    function updateAllNotes() {
      document.querySelectorAll(`#${currentMode}Pages .page`).forEach((page, pageIndex) => {
        page.querySelectorAll('.panel-bottom').forEach((panelBottom, panelIndex) => {
          if (currentMode === "us") {
            panelBottom.textContent = usRandomWords[panelIndex] || "";
            return;
          }

          panelBottom.innerHTML = '';

          manualNotes[currentMode][panelIndex]
            .filter(note => note.fromPage <= pageIndex)
            .forEach(note => {
              const wrapper = document.createElement('div');
              wrapper.className = 'note-item';

              const span = document.createElement('span');
              span.textContent = note.text;
              if (note.done) span.classList.add('strikethrough');

              const checkBtn = document.createElement('button');
              checkBtn.textContent = '✔';
              checkBtn.addEventListener('click', () => {
                note.done = !note.done;
                updateAllNotes();
              });

              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = '✖';
              deleteBtn.addEventListener('click', () => {
                manualNotes[currentMode][panelIndex] =
                  manualNotes[currentMode][panelIndex].filter(n => n !== note);
                updateAllNotes();
              });

              wrapper.appendChild(span);
              wrapper.appendChild(checkBtn);
              wrapper.appendChild(deleteBtn);
              panelBottom.appendChild(wrapper);
            });

          const inputWrapper = document.createElement('div');
          inputWrapper.className = 'note-input';

          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'Type here...';
          input.enterKeyHint = "done";

          input.addEventListener('keydown', (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              const text = input.value.trim();
              if (text) {
                manualNotes[currentMode][panelIndex].push({
                  text,
                  fromPage: currentPage,
                  done: false
                });
                updateAllNotes();
              }
            }
          });

          inputWrapper.appendChild(input);
          panelBottom.appendChild(inputWrapper);
        });
      });
    }

    function switchMode(mode) {
      lastPageByMode[currentMode] = currentPage;

      if (mode === 'us') {
        document.body.classList.remove('them');
        document.getElementById('usPages').style.display = 'flex';
        document.getElementById('themPages').style.display = 'none';
        currentMode = 'us';
      } else {
        document.body.classList.add('them');
        document.getElementById('usPages').style.display = 'none';
        document.getElementById('themPages').style.display = 'flex';
        currentMode = 'them';
      }

      currentPage = lastPageByMode[currentMode] || 0;

      updatePagePosition();
      updateAllNavs();
      updateAllPanels();
      updateAllNotes();

      document.querySelectorAll('.mode-nav button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.mode-nav').forEach(nav => {
        if (mode === 'us') nav.querySelector('button:first-child').classList.add('active');
        else nav.querySelector('button:last-child').classList.add('active');
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      buildPages('usPages');
      buildPages('themPages');
      updatePagePosition();
      updateAllNavs();
      updateAllPanels();
      updateAllNotes();
      loadWordlist();
    });
  </script>
</body>
</html>
